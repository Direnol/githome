image: ubuntu:bionic

before_script:
  - apt update
  - apt install make docker.io wget gnupg -y
  - wget https://packages.erlang-solutions.com/erlang-solutions_1.0_all.deb
  - dpkg -i erlang-solutions_1.0_all.deb
  - apt update
  - apt install esl-erlang elixir -y

stages:
  - toolchain
  - compile
  - test
  - build

tc:
  stage: toolchain
  script:
    - make tc

compile:
  stage: compile
  script:
    - make compile
  cache: &build-cache
    key: ${CI_COMMIT_SHA}-build
    paths:
      - "_build/"

test:
  stage: test
  script:
    - make test
  cache: *build-cache

build:
  stage: build
  script:
    - make deb
  artifacts:
      paths:
        - "rel/*.deb"
